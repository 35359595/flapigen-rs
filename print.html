<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>rust_swig</title>
        
        <meta name="robots" content="noindex" />
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="affix"><a href="about.html">About</a></li><li><a href="getting-started.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li><a href="cpp-example.html"><strong aria-hidden="true">1.1.</strong> C++</a></li><li><a href="java-android-example.html"><strong aria-hidden="true">1.2.</strong> Java/Android</a></li><li><a href="java-other.html"><strong aria-hidden="true">1.3.</strong> Java/Other</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">rust_swig</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p><code>rust_swig</code> is tool for connecting programs or libraries written in Rust with other languages.
Currently implemented support for <code>C++</code> and <code>Java</code>, but you can write support
for any language of your choice.
It is designed to run by cargo during via cargo's <a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html">build script</a> mechanism.</p>
<p>At first you choose what part of your Rust API will be &quot;exported&quot; to other programming language,
and how. At the second step in cargo's build script you describe where get API description and where
put resulted Rust and other language code that generated after processing API description.</p>
<p>Cooperation with other programming languages (in general) is done via C API,
so generated Rust's code is wrapper around you code to provide C API.
Generated code in other programming language is the way to make your API
as easy as possible to use in other language.</p>
<p>In the first step you should choose &quot;main&quot; crate that would be bridge between Rust and other language.
It should has <code>crate-type</code> <code>cdylib</code> or <code>staticlib</code>, see <a href="https://doc.rust-lang.org/reference/linkage.html">suitable Rust book's section</a> for detailed description.</p>
<p>For example:</p>
<pre><code class="language-toml no_run noplaypen">[lib]
name = &quot;cpp_example_rust_part&quot;
crate-type = [&quot;cdylib&quot;]
</code></pre>
<p>Then you should create <code>build.rs</code> inside this crate
For example:</p>
<pre><code class="language-rust no_run noplaypen">//build.rs
use rust_swig::{CppConfig, CppOptional, CppStrView, CppVariant, LanguageConfig};
use std::{env, path::Path};

fn main() {
    let out_dir = env::var(&quot;OUT_DIR&quot;).expect(&quot;no OUT_DIR, but cargo should provide it&quot;);
    let cpp_cfg = CppConfig::new(
        // ANCHOR: cpp_output
        Path::new(&quot;..&quot;).join(&quot;cpp-part&quot;).join(&quot;rust-api&quot;),
        // ANCHOR_END: cpp_output
        &quot;rust&quot;.into(),
    )
    .cpp_optional(CppOptional::Boost)
    .cpp_variant(CppVariant::Boost)
    .cpp_str_view(CppStrView::Boost);
    let swig_gen = rust_swig::Generator::new(LanguageConfig::CppConfig(cpp_cfg));
    swig_gen.expand(
        &quot;c++-api-for-rust&quot;,
        // ANCHOR: rust_input
        Path::new(&quot;src/cpp_glue.rs.in&quot;),
        // ANCHOR_END: rust_input

        // ANCHOR: rust_output
        &amp;Path::new(&amp;out_dir).join(&quot;cpp_glue.rs&quot;),
        // ANCHOR_END: rust_output
    );
    println!(
        &quot;cargo:rerun-if-changed={}&quot;,
        Path::new(&quot;src&quot;).join(&quot;cpp_glue.rs.in&quot;).display()
    );
}

</code></pre>
<p>Here you instruct <code>rust_swig</code> to generate C++/Rust code from &quot;src/cpp_glue.rs.in&quot; as <strong>intput</strong>:</p>
<pre><code class="language-rust no_run noplaypen">        Path::new(&quot;src/cpp_glue.rs.in&quot;),
</code></pre>
<p>and we specify our <strong>output</strong>,
Rust file:</p>
<pre><code class="language-rust no_run noplaypen">        &amp;Path::new(&amp;out_dir).join(&quot;cpp_glue.rs&quot;),
</code></pre>
<p>directory for C++ files:</p>
<pre><code class="language-rust no_run noplaypen">        Path::new(&quot;..&quot;).join(&quot;cpp-part&quot;).join(&quot;rust-api&quot;),
</code></pre>
<p>You can find detailed description of code generation in <a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html#case-study-code-generation">suitable Cargo book's section</a>.</p>
<p>Then you should create file for &quot;foreign&quot; language API description,
For example:</p>
<pre><code class="language-rust no_run noplaypen">use super::{f2, Foo};

foreigner_class!(class Foo {
    self_type Foo;
    constructor Foo::new(_: i32) -&gt; Foo;
    fn Foo::set_field(&amp;mut self, _: i32);
    fn Foo::f(&amp;self, _: i32, _: i32) -&gt; i32;
    fn f2(_: i32) -&gt; i32;
});

</code></pre>
<p>And connect generated code with your crate exactly how described in <a href="https://doc.rust-lang.org/cargo/reference/build-scripts.html#case-study-code-generation">Cargo book</a> :</p>
<pre><code class="language-rust no_run noplaypen">// src/lib.rs
mod cpp_glue;
pub use crate::cpp_glue::*;
</code></pre>
<pre><code class="language-rust no_run noplaypen">// src/cpp_glue.rs
include!(concat!(env!(&quot;OUT_DIR&quot;), &quot;/cpp_glue.rs&quot;));
</code></pre>
<p>Do not forget add <code>rust_swig</code> as dependency into <code>[build-dependencies]</code> section of crate's <code>Cargo.toml</code> file and you ready to go.</p>
<h1><a class="header" href="#c" id="c">C++</a></h1>
<p>To run cpp-example from <a href="https://github.com/Dushistov/rust_swig/tree/master/cpp_example">here</a> you need <a href="https://www.boost.org/">boost</a>, <a href="https://cmake.org/">cmake</a> and C++11 compatible compiler.</p>
<p>After that you should have no problem to call this Rust code:</p>
<pre><code class="language-rust no_run noplaypen">// src/lib.rs
pub struct Foo {
    data: i32,
}

impl Foo {
    fn new(val: i32) -&gt; Foo {
        Foo { data: val }
    }

    fn f(&amp;self, a: i32, b: i32) -&gt; i32 {
        self.data + a + b
    }

    fn set_field(&amp;mut self, v: i32) {
        self.data = v;
    }
}
</code></pre>
<p>from C++:</p>
<pre><code class="language-c++ no_run noplaypen">// main.cpp
    Foo foo(5);
    int res = foo.f(1, 2);
</code></pre>
<h1><a class="header" href="#javaandroid" id="javaandroid">Java/Android</a></h1>
<p><a href="https://github.com/Dushistov/rust_swig/tree/master/android-example">This example</a> shows off how to use rust to build a native library from android
and use it through an automatically generated JNI wrapper.</p>
<p><a href="https://developer.android.com/studio">Android Studio</a> can be used to work with Rust via <a href="https://intellij-rust.github.io/">Rust plugin</a>.
So it is not bad idea to integrate invocation of cargo into gradle,
thus you can build and run android application with Rust inside as ordinary Java/Kotlin application.</p>
<h2><a class="header" href="#project-structure" id="project-structure">Project Structure</a></h2>
<p>The file <code>build.rs</code> defines how rust_swig generates wrapper code:</p>
<pre><code class="language-rust no_run noplaypen">// build.rs
    let swig_gen = rust_swig::Generator::new(LanguageConfig::JavaConfig(
        JavaConfig::new(
            Path::new(&quot;app&quot;)
                .join(&quot;src&quot;)
                .join(&quot;main&quot;)
                .join(&quot;java&quot;)
                .join(&quot;net&quot;)
                .join(&quot;akaame&quot;)
                .join(&quot;myapplication&quot;),
            &quot;net.akaame.myapplication&quot;.into(),
        )
        .use_null_annotation_from_package(&quot;android.support.annotation&quot;.into()),
    ))
    .rustfmt_bindings(true);
</code></pre>
<p>The file <code>src/lib.rs</code> contains real code that will be invoked from Java:</p>
<pre><code class="language-rust no_run noplaypen">// src/lib.rs
struct Session {
    a: i32,
}

impl Session {
    pub fn new() -&gt; Session {
        #[cfg(target_os = &quot;android&quot;)]
        android_logger::init_once(
            android_logger::Config::default()
                .with_min_level(log::Level::Debug)
                .with_tag(&quot;Hello&quot;),
        );
        log_panics::init(); // log panics rather than printing them
        info!(&quot;init log system - done&quot;);
        Session { a: 2 }
    }

    pub fn add_and1(&amp;self, val: i32) -&gt; i32 {
        self.a + val + 1
    }

    // Greeting with full, no-runtime-cost support for newlines and UTF-8
    pub fn greet(to: &amp;str) -&gt; String {
        format!(&quot;Hello {} ✋\nIt's a pleasure to meet you!&quot;, to)
    }
}
</code></pre>
<p>And the file <code>src/java_glue.rs.in</code> contains description for rust_swig how export this API to Java:</p>
<pre><code class="language-rust no_run noplaypen">// src/java_glue.rs.in
foreigner_class!(class Session {
    self_type Session;
    constructor Session::new() -&gt; Session;
    fn Session::add_and1(&amp;self, val: i32) -&gt; i32;
    fn Session::greet(to: &amp;str) -&gt; String;
});
</code></pre>
<p>Then the <code>app/build.gradle</code> contains rule how to invokes <code>cargo</code> to build shared library from Rust code,
and then build it into apk:</p>
<pre><code class="language-groovy no_run noplaypen">// app/build.gradle
def rustBasePath = &quot;..&quot;
def archTriplets = [
    'armeabi': 'arm-linux-androideabi',
    'arm64': 'aarch64-linux-android',
]

// TODO: only pass --release if buildType is release
archTriplets.each { arch, target -&gt;
    // execute cargo metadata and get path to target directory
    tasks.create(name: &quot;cargo-output-dir-${arch}&quot;, description: &quot;Get cargo metadata&quot;) {
        new ByteArrayOutputStream().withStream { os -&gt;
            exec {
                commandLine 'cargo', 'metadata', '--format-version', '1'
                workingDir rustBasePath
                standardOutput = os
            }
            def outputAsString = os.toString()
            def json = new groovy.json.JsonSlurper().parseText(outputAsString)

            logger.info(&quot;cargo target directory: ${json.target_directory}&quot;)
            project.ext.cargo_target_directory = json.target_directory
        }
    }
    // Build with cargo
    tasks.create(name: &quot;cargo-build-${arch}&quot;, type: Exec, description: &quot;Building core for ${arch}&quot;, dependsOn: &quot;cargo-output-dir-${arch}&quot;) {
        workingDir rustBasePath
        commandLine 'cargo', 'build', &quot;--target=${target}&quot;, '--release'
    }
    // Sync shared native dependencies
    tasks.create(name: &quot;sync-rust-deps-${arch}&quot;, type: Sync, dependsOn: &quot;cargo-build-${arch}&quot;) {
        from &quot;${rustBasePath}/src/libs/${arch}&quot;
        include &quot;*.so&quot;
        into &quot;src/main/libs/${arch}&quot;
    }
    // Copy build libs into this app's libs directory
    tasks.create(name: &quot;rust-deploy-${arch}&quot;, type: Copy, dependsOn: &quot;sync-rust-deps-${arch}&quot;, description: &quot;Copy rust libs for (${arch}) to jniLibs&quot;) {
        from &quot;${project.ext.cargo_target_directory}/${target}/release&quot;
        include &quot;*.so&quot;
        into &quot;src/main/libs/${arch}&quot;
    }

    // Hook up tasks to execute before building java
    tasks.withType(JavaCompile) {
        compileTask -&gt; compileTask.dependsOn &quot;rust-deploy-${arch}&quot;
    }
    preBuild.dependsOn &quot;rust-deploy-${arch}&quot;

    // Hook up clean tasks
    tasks.create(name: &quot;clean-${arch}&quot;, type: Delete, description: &quot;Deleting built libs for ${arch}&quot;, dependsOn: &quot;cargo-output-dir-${arch}&quot;) {
        delete fileTree(&quot;${project.ext.cargo_target_directory}/${target}/release&quot;) {
            include '*.so'
        }
    }
    clean.dependsOn &quot;clean-${arch}&quot;
}
</code></pre>
<h2><a class="header" href="#building" id="building">Building</a></h2>
<p>To build the demo, you will need the latest version of Cargo, Android NDK and install proper Rust toolchains:</p>
<pre><code class="language-shell">rustup target add arm-linux-androideabi
rustup target add aarch64-linux-android
</code></pre>
<p>To link the result into shared library you need add path to proper clang binary into <code>PATH</code>
environment variable or change path to linker here:</p>
<pre><code class="language-toml">[target.aarch64-linux-android]
linker = &quot;aarch64-linux-android21-clang++&quot;
runner = &quot;./run-on-adroid.sh&quot;

[target.arm-linux-androideabi]
linker = &quot;armv7a-linux-androideabi21-clang++&quot;
runner = &quot;./run-on-adroid.sh&quot;

</code></pre>
<h2><a class="header" href="#invocation" id="invocation">Invocation</a></h2>
<p>Gradle will take care of building and deploying the Rust sources. Thus, to build
the project in release mode, simply call <code>./gradlew androidRelease</code>.</p>
<p>To build only the rust libraries for a specific target, call cargo as usual, e.g.
<code>cargo build --target arm-linux-androideabi</code>.</p>
<h2><a class="header" href="#testing" id="testing">Testing</a></h2>
<p>It is possible to run Rust unit tests on Android phone via <code>run-on-android.sh</code> script mentioned in <code>.cargo/config</code>,
also there is instrumentation unit test on Java that invoke Rust code.</p>
<h1><a class="header" href="#javaother" id="javaother">Java/Other</a></h1>
<p>TODO</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
